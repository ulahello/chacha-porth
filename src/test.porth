include "std.porth"
include "chacha.porth"

inline proc trunc32 int -- int in
  4294967295 and
end

proc test_utils in
  4294967295 1 + trunc32 0 != if
    "[test_utils] addition failed\n" puts
    1 exit
  end

  42 111 xor 69 != if
    "[test_utils] xor failed\n" puts
    1 exit
  end

  4521984 16 rotl32 trunc32 69 != if
     "[test_utils] rotl failed\n" puts
     1 exit
  end

  "[test_utils] passed\n" puts
end

proc test_2.1.1 in
  286331153    // a = 0x11111111
    16909060   // b = 0x01020304
    2609737539 // c = 0x9b8d6f43
    19088743   // d = 0x01234567
    qr

    dup 1484899515 != if // assert d == 0x5881c4bb
      "[2.1.1] d: unexpected " puts putu "\n" puts
      1 exit
      else drop
    end

    dup 1166100270 != if // assert c == 0x4581472e
      "[2.1.1] c: unexpected " puts putu "\n" puts
      1 exit
      else drop
    end

    dup 3407673550 != if // assert b == 0xcb1cf8ce
      "[2.1.1] b: unexpected " puts putu "\n" puts
      1 exit
      else drop
    end

  dup 3928658676 != if // assert a == 0xea2a92f4
    "[2.1.1] a: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  "[2.1.1] passed\n" puts
end

proc test_2.2.1 in
  memory state sizeof(State) end
    2274701792 // 0x879531e0
    3320640381 // 0xc5ecf37d
    1365533105 // 0x516461b1
    3383111562 // 0xc9a62f8a
    1153568499 // 0x44c20ef3
    865120127  // 0x3390af7f
    3657197835 // 0xd9fc690b
    710897996  // 0x2a5f714c
    1396123495 // 0x53372767
    2953467441 // 0xb00a5631
    2538361882 // 0x974c541a
    899586403  // 0x359e9963
    1553404001 // 0x5c971061
    1029904009 // 0x3d631689
    546888150  // 0x2098d9d6
    2447102752 // 0x91dbd320
  state !State

  // compute quarter round with indexes
  2 7 8 13 state qr_index

  // push d, c, b, a to stack
  state sizeof(word) 13 * ptr+ @32
  state sizeof(word)  8 * ptr+ @32
  state sizeof(word)  7 * ptr+ @32
  state sizeof(word)  2 * ptr+ @32

  dup 3182986972 != if // assert a == 0xbdb886dc
    "[2.2.1] a: unexpected: " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3484200914 != if // assert b == 0xcfacafd2
    "[2.2.1] b: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3832277632 != if // assert c == 0xe46bea80
    "[2.2.1] c: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3435166841 != if // assert d == 0xccc07c79
    "[2.2.1] d: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  "[2.2.1] passed\n" puts
end

proc test_2.3.2_check1
  int int int int int int int int int int int int int int int int
  --
in
  dup 1312575650 != if // 0x4e3c50a2
    "[2.3.2] after 20 rounds [15]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 2659438795 != if // 0x9e83d0cb
    "[2.3.2] after 20 rounds [14]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 2957907678 != if // 0xb04e16de
    "[2.3.2] after 20 rounds [13]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3516666548 != if // 0xd19c12b4
    "[2.3.2] after 20 rounds [12]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 2196008637 != if // 0x82e46ebd
    "[2.3.2] after 20 rounds [11]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3938298108 != if // 0xeabda8fc
    "[2.3.2] after 20 rounds [10]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 4069820915 != if // 0xf29489f3
    "[2.3.2] after 20 rounds [9]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 861041090  != if // 0x335271c2
    "[2.3.2] after 20 rounds [8]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 1063176119 != if // 0x3f5ec7b7
    "[2.3.2] after 20 rounds [7]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 2409634044 != if // 0x8fa018fc
    "[2.3.2] after 20 rounds [6]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 4234328879 != if // 0xfc62bb2f
    "[2.3.2] after 20 rounds [5]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3304247495 != if // 0xc4f2d0c7
    "[2.3.2] after 20 rounds [4]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 1498463023 != if // 0x5950bb2f
    "[2.3.2] after 20 rounds [3]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 2793071134 != if // 0xa67ae21e
    "[2.3.2] after 20 rounds [2]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3795375971 != if // 0xe238d763
    "[2.3.2] after 20 rounds [1]: unexpected " puts putu "\n" puts
    1 exit
   else drop
  end

  dup 2205644971 != if // 0x837778ab
    "[2.3.2] after 20 rounds [0]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end
end

proc test_2.3.2_check2
  int int int int int int int int int int int int int int int int
  --
in
  dup 1312575650 != if // 0x4e3c50a2
    "[2.3.2] after adding original state [15]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3900952779 != if // 0xe883d0cb
    "[2.3.2] after adding original state [14]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3108902622 != if // 0xb94e16de
    "[2.3.2] after adding original state [13]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3516666549 != if // 0xd19c12b5
    "[2.3.2] after adding original state [12]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 2718075865 != if // 0xa2028bd9
    "[2.3.2] after adding original state [11]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 98026004 != if // 0x05d7c214
    "[2.3.2] after adding original state [10]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 162176775 != if // 0x09aa9f07
    "[2.3.2] after adding original state [9]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 1180992210 != if // 0x466482d2
    "[2.3.2] after adding original state [8]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 1315755203 != if // 0x4e6cd4c3
    "[2.3.2] after adding original state [7]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 2594841092 != if // 0x9aaa2204
    "[2.3.2] after adding original state [6]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 57196595 != if // 0x0368c033
    "[2.3.2] after adding original state [5]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3354710471 != if // 0xc7f4d1c7
    "[2.3.2] after adding original state [4]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3295748259 != if // 0xc47120a3
    "[2.3.2] after adding original state [3]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 534581072 != if // 0x1fdd0f50
    "[2.3.2] after adding original state [2]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 358169553 != if // 0x15593bd1
    "[2.3.2] after adding original state [1]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3840405776 != if // 0xe4e7f110
    "[2.3.2] after adding original state [0]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end
end

proc test_2.3.2_check3
  int int int int int int int int int int int int int int int int
  --
in
  dup 1312575650 != if // 0x4e3c50a2
    "[2.3.2] after full 20 round block [15]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3900952779 != if // 0xe883d0cb
    "[2.3.2] after full 20 round block [14]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3108902622 != if // 0xb94e16de
    "[2.3.2] after full 20 round block [13]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3516666549 != if // 0xd19c12b5
    "[2.3.2] after full 20 round block [12]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 2718075865 != if // 0xa2028bd9
    "[2.3.2] after full 20 round block [11]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 98026004 != if // 0x05d7c214
    "[2.3.2] after full 20 round block [10]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 162176775 != if // 0x09aa9f07
    "[2.3.2] after full 20 round block [9]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 1180992210 != if // 0x466482d2
    "[2.3.2] after full 20 round block [8]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 1315755203 != if // 0x4e6cd4c3
    "[2.3.2] after full 20 round block [7]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 2594841092 != if // 0x9aaa2204
    "[2.3.2] after full 20 round block [6]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 57196595 != if // 0x0368c033
    "[2.3.2] after full 20 round block [5]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3354710471 != if // 0xc7f4d1c7
    "[2.3.2] after full 20 round block [4]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3295748259 != if // 0xc47120a3
    "[2.3.2] after full 20 round block [3]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 534581072 != if // 0x1fdd0f50
    "[2.3.2] after full 20 round block [2]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 358169553 != if // 0x15593bd1
    "[2.3.2] after full 20 round block [1]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end

  dup 3840405776 != if // 0xe4e7f110
    "[2.3.2] after full 20 round block [0]: unexpected " puts putu "\n" puts
    1 exit
    else drop
  end
end

proc test_2.3.2 in
  memory state sizeof(State) end
    1634760805 // 0x61707865
    857760878  // 0x3320646e
    2036477234 // 0x79622d32
    1797285236 // 0x6b206574
    50462976   // 0x03020100
    117835012  // 0x07060504
    185207048  // 0x0b0a0908
    252579084  // 0x0f0e0d0c
    319951120  // 0x13121110
    387323156  // 0x17161514
    454695192  // 0x1b1a1918
    522067228  // 0x1f1e1d1c
    1          // 0x00000001
    150994944  // 0x09000000
    1241513984 // 0x4a000000
    0          // 0x00000000
  state !State

  memory original sizeof(State) end
  sizeof(State) state original memcpy drop

  // 20 rounds of chacha without final matrix addition
  state 20 block_no_add

  state @State
  test_2.3.2_check1 // TODO: bring this function back into body when type checking can handle it

  // add original input to state
  state original state+

  state @State
  test_2.3.2_check2 // TODO: bring this function back into body when type checking can handle it

  // do the same as previous two, but let chacha.porth do the addition
  // at the end, `original` and `state` should be the same
  original 20 block

  original @State
  test_2.3.2_check3 // TODO: bring this function back into body when type checking can handle it

  "[2.3.2] passed\n" puts
end

proc main in
  test_utils
  test_2.1.1
  test_2.2.1
  test_2.3.2
end
